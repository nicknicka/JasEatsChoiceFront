# 佳食宜选数据库优化修改说明

## 一、优化背景
为了提高数据库的一致性、性能和可维护性，对佳食宜选数据库的表结构、字段类型和索引进行了系统优化。

## 二、主要优化点

### 1. 添加外键约束
**优化前**：表之间没有外键约束，存在数据不一致风险。
**优化后**：为所有关联字段添加外键约束，确保数据一致性。

### 2. 合并冗余表
**优化前**：
- t_user表包含用户基本信息
- t_user_preference表包含用户偏好设置
- 两个表存在重复字段（如disable_weather_recommend、diet_goal、allergies等）

**优化后**：
- 将t_user_preference表的功能合并到t_user表中
- 统一存储用户基本信息和偏好设置
- 删除t_user_preference表的冗余结构

### 3. 优化字段类型和长度
**优化内容**：
- t_chat_msg.from_id/to_id：从varchar改为bigint类型，统一内部ID存储格式
- t_review.images：从varchar(2000)改为text类型，支持更长的图片URL列表
- 优化t_address表的字段长度，确保符合实际需求

### 4. 优化订单表结构
**优化前**：t_order表中的address字段直接存储地址字符串，存在数据冗余
**优化后**：t_order表添加address_id字段，关联t_address表，支持地址的统一管理和维护

### 5. 增强索引设计
**优化内容**：
- 为t_review表添加复合索引`idx_merchant_rating_time`，优化商家评价查询
- 为t_calorie_record表添加复合索引`idx_user_meal_time`，优化卡路里记录查询
- 为t_address表添加`idx_is_default`索引，优化默认地址查询

### 6. 统一JSON字段处理
**优化内容**：
- 使用JsonNode类型统一处理JSON字段，提高类型安全性
- 确保所有JSON字段有明确的格式约定

## 三、修改影响范围

### 1. 数据库层面
- 需要重新创建或修改现有的数据库表
- 需要确保应用程序在修改期间的兼容性

### 2. 应用程序层面
- User实体类已更新，包含了原UserPreference的所有字段
- 需要修改相关的Mapper和Service以适应合并后的表结构
- 聊天消息相关的处理需要适应ID类型的变化
- 订单相关的处理需要适应地址字段的变化

## 四、升级步骤

1. **备份数据**：在升级前备份所有数据库表
2. **创建新表**：使用优化后的脚本创建新的数据库表结构
3. **数据迁移**：
   - 将原t_user和t_user_preference的数据合并迁移到新的t_user表
   - 迁移t_order表数据，将address字符串转换为address_id
   - 迁移t_chat_msg表数据，将varchar类型的ID转换为bigint
4. **更新应用**：部署更新后的应用程序
5. **测试验证**：确保所有功能正常运行
6. **清理旧表**：在验证通过后，可以考虑删除旧表

## 五、注意事项

1. **兼容性**：确保应用程序的所有版本能够适应新的数据库结构
2. **性能**：新的索引设计将提高查询性能，但需要注意插入和更新操作的性能影响
3. **数据迁移**：在数据迁移过程中需要确保数据的完整性和准确性
4. **文档更新**：需要更新相关的数据库文档和API文档

## 六、总结
这次数据库优化提高了系统的数据一致性和性能，同时简化了数据库结构。在升级过程中需要仔细规划和测试，以确保系统的稳定性和可用性。