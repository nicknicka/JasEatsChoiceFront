# 💬 用户单聊会话详情页面设计（PRD规范版）
## 设计依据：产品需求说明书 4.4.2 社交聊天与订单协同-单聊模式 + 订单关联优化需求 + 角色规则更新
## 统一基础框架
```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│ 【佳食宜选】                          [🔍 搜索框(居中)]                      👤/🏪 | 用户名   │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────┬─────────────────────────────────────────────────────────────┐ │
│  │  🤦‍♂️ [头像=个人中心]       │ 【单聊：XX餐厅】                                    ↩ 返回   │ │
│  │  📌 (我的推荐)            │ ┌─────────────────────────────────────────────────────┐       │ │
│  │ 🏪 (商家查找)             | |                                                       |     |  |
|  | 📅 (今日食谱)            │ │  ⏰ 10:00 商家：您好！需要点什么吗？我可以给您推荐菜单          │       │ │
│  │  📊 (卡路里统计)          │ │  ⏰ 10:02 我：给我看看你们的招牌菜                         │       │ │
│  │  📚 (我的食谱)            │ │  ⏰ 10:03 商家：[上传菜单] 招牌菜系列                        │       │ │
│  │  💬 (消息中心)            │ │  ⏰ 10:03 系统：已接收结构化菜单，预估总价：156元          │       │ │
│  │  🤖 (AI聊天助手)          │ │  ⏰ 10:05 我：帮我改成少辣的                                       │       │ │
│  │  ⚙️ (设置-底部)           │ │  ⏰ 10:06 商家：好的，已备注少辣！                                     │       │ │  | 
│  │                          │ └─────────────────────────────────────────────────────┘       │ │
│  │                          │ ┌─────────────────────────────────────────────────────┐       │ │
│  │                          │ │  📋 当前关联订单：2025-11-20 12:30 待上菜｜宫保鸡丁 + 米饭 │       │ │
│  │                          │ │  💰 订单金额：28元                              [🔄 切换订单]      │       │ │
│  │                          │ │  📌 备注：少辣，米饭多一点                                     │       │ │
│  │                          │ │  ┌─────────────────────────────────────────────┐           │ │
│  │                          │ │  │ 2025-11-19 18:00 已完成｜鱼香肉丝面       │ 订单列表   │ │
│  │                          │ │  │ 2025-11-18 12:30 已完成｜番茄炒蛋饭       │           │ │
│  │                          │ │  └─────────────────────────────────────────────┘           │ │
│  │                          │ └─────────────────────────────────────────────────────┘       │ │
│  │                          │ ┌─────────────────────────────────────────────────────┐       │ │
│  │                          │ │  📝 输入框：[ 请输入消息... ]  ⏎ 发送                        │       │ │
│  │                          │ │  💡 注：仅商家可上传结构化菜单，用户发送菜单将切换会话角色      │       │ │
│  └───────────────────────────┴─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```
## 核心设计点（严格遵循PRD + 优化更新）
1. **角色规则**：仅接单方为商户，商户可发送自己店铺的菜单给下单用户
2. **菜单上传权限**：仅商户可上传结构化菜单，用户无此权限
3. **自动核算总价**：系统自动核算上传菜单的预估总价
4. **智能订单关联**：基于优先级规则绑定最近活跃订单
5. **手动切换订单**：用户和商家均可切换关联订单，显示近30天所有订单
6. **角色切换规则**：若下单用户发送自己店铺的菜单给商户，商户可查看；若下单会跳转至角色互换的新会话（原下单用户→商户，原商户→下单用户）
7. **消息操作**：支持聊天记录按商家/店铺筛选、置顶与删除

---

## 订单关联规则（优先级从高到低）
### 1. 最近活跃订单判定
- **未完成订单**：待接单→待上菜状态，按「订单创建时间」倒序取最新
- **已完成订单**：若无可未完成订单，取最近30天内的已完成订单，按「订单完成时间」倒序取最新
- **无订单状态**：若用户无任何订单，会话暂不绑定订单，提示「暂无关联订单，可创建订单后自动关联」

### 2. 手动切换功能
- **操作权限**：用户和商家均可切换关联订单
- **订单范围**：显示用户近30天所有订单，按时间倒序排列
- **订单标识**：标注订单状态 + 核心信息，格式：「YYYY-MM-DD HH:MM 状态｜菜品1 + 菜品2」
- **切换方式**：点击「🔄 切换订单」展开订单列表，点击任意订单即可切换

---

## 交互逻辑
1. 商家上传结构化菜单后，系统自动解析并核算预估总价
2. 系统根据规则自动关联最近活跃订单
3. 点击菜单可直接跳转至下单页面，自动关联当前会话订单
4. 用户或商家可点击「🔄 切换订单」查看并切换近30天所有订单
5. 切换后，后续消息自动关联至所选订单
6. 若用户发送自己店铺的菜单给商户，系统提示"将创建角色互换的新会话"，确认后跳转
7. 聊天记录支持按商家/店铺筛选，便于查找不同商家的聊天历史
8. 支持聊天会话的置顶与删除操作
